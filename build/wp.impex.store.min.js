var wp;((wp||={}).impex||={}).store=(()=>{var j=Object.create;var P=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var f=(p,a)=>()=>(a||p((a={exports:{}}).exports,a),a.exports),B=(p,a)=>{for(var l in a)P(p,l,{get:a[l],enumerable:!0})},D=(p,a,l,T)=>{if(a&&typeof a=="object"||typeof a=="function")for(let u of z(a))!W.call(p,u)&&u!==l&&P(p,u,{get:()=>a[u],enumerable:!(T=q(a,u))||T.enumerable});return p};var h=(p,a,l)=>(l=p!=null?j(K(p)):{},D(a||!p||!p.__esModule?P(l,"default",{value:p,enumerable:!0}):l,p)),G=p=>D(P({},"__esModule",{value:!0}),p);var A=f((te,R)=>{R.exports=window.wp.data});var b=f((re,v)=>{v.exports=window.wp.apiFetch});var X=f((oe,U)=>{U.exports=window.wp.url});var L=f((pe,F)=>{F.exports=wp.impex.debug});var k=f((ae,M)=>{M.exports=window.wp.i18n});var Z={};B(Z,{KEY:()=>H,default:()=>V});var I=h(A(),1),n=h(b(),1),_=h(X(),1),C=h(L(),1),s=h(k(),1),x=C.default.default("wp.impex.store");x("loaded");var H="cm4all/impex";async function V(p){let{namespace:a,base_uri:l,site_url:T}=p,u={settings:p,imports:[],exports:[],importProfiles:[],exportProfiles:[]},S=await(0,n.default)({path:"/"});if(!S.namespaces.includes(a))throw`rest discovery doesn't provide expected impex rest namespace(=${a})`;if(!S.routes[l])throw`rest discovery doesn't provide expected impex rest route (=${l})`;let N={createAndUploadConsumeImport:(e,r,t)=>async function*({dispatch:o,registry:i,resolveSelect:E,select:w}){x({importProfile:e,importOptions:r});let d=null;try{d=await window.showDirectoryPicker({startIn:"downloads",id:"impex-import-dir"})}catch{return}yield{type:"progress",title:(0,s.__)("Import","cm4all-wp-impex"),message:(0,s.__)("Creating snapshot ...","cm4all-wp-impex")};let c=(await o.createImport(`transient-import-${window.crypto.randomUUID()}`,`machine generated transient export snapshot created using profile ${e.name}`,e,{})).payload;try{yield{type:"progress",title:(0,s.__)("Import","cm4all-wp-impex"),message:(0,s.__)("Uploading slices ...","cm4all-wp-impex")};let m=await t._getSliceFilesToImport(d),y=await t._uploadSlices(c,m);yield{type:"progress",title:(0,s.__)("Import","cm4all-wp-impex"),message:(0,s.__)("Importing slices ...","cm4all-wp-impex")},await o.consumeImport(c.id,r,null,null),await(yield{type:"info",title:(0,s.__)("Import completed","cm4all-wp-impex"),message:(0,s.__)("Successfully finished import.","cm4all-wp-impex")})}finally{c&&await o.deleteImport(c.id)}},createAndDownloadExport:(e,r)=>async function*({dispatch:t,registry:o,resolveSelect:i,select:E}){let w=null;try{w=await window.showDirectoryPicker({startIn:"downloads",mode:"readwrite",id:"impex-export-dir"})}catch{return}let d=r.normalizeFilename(`${window.location.hostname}-${e.name}-${r.currentDateString()}`);if(d=prompt("Enter name of the export (max 32 characters):",d),!d){await(yield{type:"info",title:(0,s.__)("Export aborted","cm4all-wp-impex"),message:(0,s.__)("You canceled the export or entered an invalid export name","cm4all-wp-impex")});return}try{throw await w.getDirectoryHandle(d,{create:!1}),new Error(`Export folder ${d} already exists. Please remove/rename it and continue.
(${ex.message})`)}catch{}let c=await w.getDirectoryHandle(d,{create:!0});x({exportDirHandle:c});let m=null;try{yield{type:"progress",title:(0,s.__)("Export","cm4all-wp-impex"),message:(0,s.__)("Creating snapshot","cm4all-wp-impex")},m=(await t.createExport(e,`transient-export-${window.crypto.randomUUID()}`,`machine generated transient snapshot created using profile ${e.name}`)).payload;let y=`${p.base_uri}/export/${m.id}/slice`;yield{type:"progress",title:(0,s.__)("Downloading snapshot","cm4all-wp-impex"),message:(0,s.__)("Creating snapshot","cm4all-wp-impex")};let O=await(0,n.default)({path:y,parse:!1}),Y=Number.parseInt(O.headers.get("X-WP-TotalPages")),$=[r.saveSlicesChunk(c,O.json(),1)];for(let g=2;g<=Y;g++)$.push(r.saveSlicesChunk(c,(0,n.default)({path:_.default.addQueryArgs(y,{page:g})}),g));await Promise.all($),await(yield{type:"info",title:(0,s.__)("Export completed","cm4all-wp-impex"),message:(0,s.__)("Successfully finished export.","cm4all-wp-impex")})}finally{m?await t.deleteExport(m.id):await w.removeEntry(c.name,{recursive:!0})}},async createExport(e,r="",t=""){return{type:"ADD_EXPORT",payload:await(0,n.default)({path:`${p.base_uri}/export`,method:"POST",data:{profile:e.name,name:r,description:t}})}},setExports(e){return{type:"SET_EXPORTS",payload:e}},async updateExport(e,r){return{type:"UPDATE_EXPORT",payload:await(0,n.default)({path:`${u.settings.base_uri}/export/${e}`,method:"PATCH",data:r})}},async deleteExport(e){let r=await(0,n.default)({path:`${p.base_uri}/export/${e}`,method:"DELETE"});return{type:"DELETE_EXPORT",payload:e}},async createImport(e,r,t,o){return{type:"ADD_IMPORT",payload:await(0,n.default)({path:`${p.base_uri}/import`,method:"POST",data:{name:e,description:r,profile:t.name,options:o}})}},async consumeImport(e,r={},t=null,o=null){let i={};t!==null&&(i.offset=t),o!==null&&(i.limit=o);let{log:E,callbacks:w=[],notConsumedSlices:d}=await(0,n.default)({path:_.default.addQueryArgs(`${p.base_uri}/import/${e}/consume`,i),method:"POST",data:{options:r}}),c=w.map(m=>(0,n.default)({path:`${p.base_uri}/${m.path}`,method:m.method,data:m.data}).catch(y=>{if(y.code==="fetch_error")return E.push({type:"warning",message:`Ignore post consume callback(='${m.path}') response : server side timed out(data=${JSON.stringify(m.data)})`,cause:[]}),Promise.resolve()}));return await Promise.all(c),x(`consumeImport(%o, %o, %s, %o).log=
%o`,e,JSON.stringify(r),t,o,E),{type:"",payload:{log:E,notConsumedSlices:d}}},setImports(e){return{type:"SET_IMPORTS",payload:e}},async updateImport(e,r){return{type:"UPDATE_IMPORT",payload:await(0,n.default)({path:`${u.settings.base_uri}/import/${e}`,method:"PATCH",data:r})}},async deleteImport(e){let r=await(0,n.default)({path:`${p.base_uri}/import/${e}`,method:"DELETE"});return{type:"DELETE_IMPORT",payload:e}}},J={getExportProfile(e,r){return e.exportProfiles.find(t=>t.name===r)},getExportProfiles(e){return e.exportProfiles},getExport(e,r){return e.exports.find(t=>t.id===r)},getExports(e){return e.exports},getImportProfile(e,r){return e.importProfiles.find(t=>t.name===r)},getImportProfiles(e){return e.importProfiles},getImport(e,r){return e.imports.find(t=>t.id===r)},getImports(e){return e.imports},getSettings(e){return e.settings}},Q=I.default.createReduxStore(H,{__experimentalUseThunks:!0,reducer(e=u,{type:r,payload:t}){switch(r){case"ADD_EXPORT":return{...e,exports:[t,...e.exports]};case"UPDATE_EXPORT":{let o=e.exports.findIndex(i=>i.id===t.id);return o===-1&&x("Export(id=%s) is unknown",t.id),e.exports.splice(o,1,t),{...e,exports:[...e.exports]}}case"DELETE_EXPORT":{let o=e.exports.findIndex(i=>i.id===t);return o===-1&&x("Export(id=%s) is unknown",t),e.exports.splice(o,1),{...e,exports:[...e.exports]}}case"SET_EXPORTS":return{...e,exports:[...t]};case"SET_EXPORTPROFILES":return{...e,exportProfiles:[...t].sort((o,i)=>o.name.localeCompare(i.name))};case"ADD_IMPORT":return{...e,imports:[t,...e.imports]};case"UPDATE_IMPORT":{let o=e.imports.findIndex(i=>i.id===t.id);return o===-1&&x("Export(id=%s) is unknown",t.id),e.imports.splice(o,1,t),{...e,imports:[...e.imports]}}case"DELETE_IMPORT":{let o=e.imports.findIndex(i=>i.id===t);return o===-1&&x("Export(id=%s) is unknown",t),e.imports.splice(o,1),{...e,imports:[...e.imports]}}case"SET_IMPORTS":return{...e,imports:[...t]};case"SET_IMPORTPROFILES":return{...e,importProfiles:[...t].sort((o,i)=>o.name.localeCompare(i.name))}}return e},actions:N,selectors:J,resolvers:{async getExportProfiles(){return{type:"SET_EXPORTPROFILES",payload:await(0,n.default)({path:`${l}/export/profile`})}},async getExports(){return{type:"SET_EXPORTS",payload:await(0,n.default)({path:`${l}/export`})}},async getImportProfiles(){return{type:"SET_IMPORTPROFILES",payload:await(0,n.default)({path:`${l}/import/profile`})}},async getImports(){return{type:"SET_IMPORTS",payload:await(0,n.default)({path:`${l}/import`})}}}});I.default.register(Q)}return G(Z);})();
